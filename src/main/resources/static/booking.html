<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>包廂預約</title>
  <link th:href="@{assets/vendor/bootstrap/css/bootstrap.min.css}" rel="stylesheet">
  <link th:href="@{assets/vendor/bootstrap-icons/bootstrap-icons.css}" rel="stylesheet">
  <link th:href="@{assets/css/main.css}" rel="stylesheet">
</head>
<body class="index-page">

  <header id="header" class="header d-flex align-items-center sticky-top">
    <div class="container d-flex justify-content-between align-items-center">
      <a th:href="@{/index.html}" class="logo d-flex align-items-center">
        <i class="bi bi-box-seam"></i>
        <h1 class="sitename">iZoneHub</h1>
      </a>
    </div>
  </header>

  <main class="main">
    <section class="section">
      <div class="container">
        <div class="section-title text-center">
          <h2>包廂預約（整點選擇）</h2>
          <p>請選擇開始與結束時間（日期＋小時）</p>
        </div>

        <div id="selectedRoom" class="mb-4 text-center">
          <!-- 顯示選擇的房間 -->
           <h2 id="selectedRoomName"></h2>
          <img id="selectedRoomImage" src="" class="img-fluid rounded-3 mb-3" style="max-width:400px;">
        </div>

        <form id="bookingForm" class="php-email-form">
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="startDate">開始日期</label>
              <input type="date" id="startDate" name="startDate" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label for="startHour">開始時間（整點）</label>
              <select id="startHour" name="startHour" class="form-control" required></select>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label for="endDate">結束日期</label>
              <input type="date" id="endDate" name="endDate" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label for="endHour">結束時間（整點）</label>
              <select id="endHour" name="endHour" class="form-control" required></select>
            </div>
          </div>

          <div class="mb-3">
            <label>試算金額</label>
            <div id="priceDisplay" class="fs-4">$0</div>
          </div>

          <div class="text-center">
            <button type="submit" class="btn custom-gold-btn">立即結帳</button>
          </div>
        </form>
      </div>
    </section>
  </main>


<script th:inline="javascript">
  /*<![CDATA[*/

  // 1. 從 Thymeleaf Model 獲取由 Controller 傳遞的房間資料
  const room = /*[[${room}]]*/ null;

  document.addEventListener('DOMContentLoaded', () => {
    if (room) {
      // 2. 更新頁面上的房間資訊
      document.getElementById('selectedRoomName').innerText = room.name;
      const roomImageElement = document.getElementById('selectedRoomImage');
      roomImageElement.src = /*[[@{__${room.image}__}]]*/ ''; // 使用 Thymeleaf 處理圖片路徑
      roomImageElement.alt = room.name;

      // 填充小時下拉選單
      populateHours('startHour');
      populateHours('endHour');

      // 綁定事件監聽器以計算價格
      document.getElementById('startDate').addEventListener('change', calculatePrice);
      document.getElementById('endDate').addEventListener('change', calculatePrice);
      document.getElementById('startHour').addEventListener('change', calculatePrice);
      document.getElementById('endHour').addEventListener('change', calculatePrice);

      // 處理表單提交
      document.getElementById('bookingForm').addEventListener('submit', handleBookingSubmit);

    } else {
      // 如果沒有房間資料，顯示錯誤訊息
      document.getElementById('selectedRoom').innerHTML = '<p class="text-danger">錯誤：找不到指定的房間資訊。</p>';
      document.getElementById('bookingForm').style.display = 'none'; // 隱藏表單
    }
  });

  // 產生 0-23 點的下拉選單
  function populateHours(selectId) {
    const select = document.getElementById(selectId);
    select.innerHTML = '';
    for (let i = 0; i < 24; i++) {
      const h = i.toString().padStart(2, '0');
      const option = document.createElement('option');
      option.value = h;
      option.textContent = `${h}:00`;
      select.appendChild(option);
    }
  }

  // 計算並顯示預估價格
  function calculatePrice() {
    const startDate = document.getElementById('startDate').value;
    const startHour = document.getElementById('startHour').value;
    const endDate = document.getElementById('endDate').value;
    const endHour = document.getElementById('endHour').value;
    const priceDisplay = document.getElementById('priceDisplay');

    if (startDate && startHour && endDate && endHour) {
      const start = new Date(`${startDate}T${startHour}:00:00`);
      const end = new Date(`${endDate}T${endHour}:00:00`);

      if (end > start) {
        const diffMs = end - start;
        const hours = diffMs / (1000 * 60 * 60);
        priceDisplay.textContent = `$${hours * room.price}`;
      } else {
        priceDisplay.textContent = '$0';
      }
    }
  }

  // 處理預約表單提交
  function handleBookingSubmit(e) {
    e.preventDefault();
    const startDate = document.getElementById('startDate').value;
    const startHour = document.getElementById('startHour').value;
    const endDate = document.getElementById('endDate').value;
    const endHour = document.getElementById('endHour').value;

    const start = new Date(`${startDate}T${startHour}:00:00`);
    const end = new Date(`${endDate}T${endHour}:00:00`);

    if (end <= start) {
      alert('結束時間必須晚於開始時間');
      return;
    }

    const hours = (end - start) / (1000 * 60 * 60);
    const total = hours * room.price;

    alert(`已預約：\n房間：${room.name}\n從：${startDate} ${startHour}:00\n到：${endDate} ${endHour}:00\n總時數：${hours} 小時\n總金額：$${total}`);
    // 在此處可以加入將預約資料傳送到後端的邏輯
  }

  /*]]>*/
</script>

</body>
</html>
